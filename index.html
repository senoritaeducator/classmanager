<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Class Manager ‚Äî LazifAI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, #e0e7ff 0, #f5f7ff 30%, #fdfbff 65%, #ffffff 100%);
            min-height: 100vh;
            padding: 16px;
            color: #0f172a;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Header */
        .top-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: stretch;
            gap: 16px;
            margin-bottom: 16px;
        }

        .brand-block {
            flex: 1 1 260px;
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 40%, #a855f7 100%);
            border-radius: 20px;
            padding: 16px 18px;
            color: #eef2ff;
            box-shadow: 0 14px 30px rgba(79, 70, 229, 0.35);
            position: relative;
            overflow: hidden;
        }

        .brand-block::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.22), transparent 60%);
            pointer-events: none;
        }

        .brand-title {
            font-size: 1.35rem;
            font-weight: 700;
            letter-spacing: 0.04em;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brand-title span.icon {
            font-size: 1.3rem;
        }

        .brand-sub {
            font-size: 0.84rem;
            opacity: 0.9;
        }

        .brand-pill-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            margin-top: 10px;
            font-size: 0.72rem;
            overflow-x: auto;
            padding-bottom: 2px;
        }

        .brand-pill-row::-webkit-scrollbar {
            height: 4px;
        }

        .brand-pill-row::-webkit-scrollbar-thumb {
            background: rgba(15,23,42,0.35);
            border-radius: 999px;
        }

        .brand-pill {
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(15,23,42,0.15);
            border: 1px solid rgba(191, 219, 254, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }

        .teacher-block {
            background: #ffffff;
            border-radius: 18px;
            padding: 12px 16px;
            min-width: 230px;
            box-shadow: 0 10px 26px rgba(15,23,42,0.08);
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .teacher-block::before {
            content: "üë©‚Äçüè´";
            position: absolute;
            right: 10px;
            bottom: 6px;
            font-size: 1.6rem;
            opacity: 0.14;
        }

        .teacher-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .teacher-name {
            font-weight: 600;
            font-size: 1rem;
            color: #111827;
        }

        .teacher-id {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .teacher-clock {
            margin-top: 4px;
            font-size: 0.8rem;
            color: #4b5563;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* NEW avatar styling */
        .teacher-avatar {
            position: absolute;
            right: 16px;
            top: 16px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.9);
        }

        @media (max-width: 768px) {
            .teacher-avatar {
                right: 12px;
                top: 12px;
                width: 44px;
                height: 44px;
            }
        }

        /* Tabs */
        .global-search-wrap {
            margin: 6px 0 8px;
            display: none; /* search hidden, logic still intact */
        }

        .global-search-input {
            width: 100%;
            padding: 7px 10px;
            border-radius: 999px;
            border: 1px solid #d1d5db;
            font-size: 0.86rem;
            background: #f9fafb;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .global-search-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px rgba(79,70,229,0.18);
            background: #ffffff;
        }

        .main-tabs {
            display: flex;
            gap: 8px;
            margin: 4px 0 12px;
        }

        .main-tab-btn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: rgba(249, 250, 251, 0.95);
            font-size: 0.9rem;
            font-weight: 600;
            color: #4b5563;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.18s ease;
        }

        .main-tab-btn span.tab-icon {
            font-size: 1.05rem;
        }

        .main-tab-btn.active {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 10px 22px rgba(79,70,229,0.35);
            transform: translateY(-1px);
        }

        .main-tab-btn:not(.active):hover {
            background: #eef2ff;
        }

        .section {
            display: none;
        }

        .section.show {
            display: block;
        }

        /* Section cards */
        .section-card {
            background: #ffffff;
            border-radius: 18px;
            padding: 16px 16px 18px;
            box-shadow: 0 10px 26px rgba(15,23,42,0.06);
            margin-bottom: 14px;
            border: 1px solid #e5e7eb;
            position: relative;
            overflow: hidden;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .section-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 32px rgba(15,23,42,0.08);
        }

        .section-card::before {
            content: "";
            position: absolute;
            inset-inline-start: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #4f46e5, #a855f7);
            opacity: 0.4;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
            gap: 8px;
        }

        .section-title-row {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .section-title-icon {
            font-size: 1.05rem;
        }

        .section-title {
            font-size: 1.02rem;
            font-weight: 600;
            color: #111827;
        }

        .section-caption {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .section-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .card-column {
            flex: 1 1 260px;
        }

        /* Overview mini-cards */
        .overview-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .overview-tile {
            flex: 1 1 180px;
            padding: 8px 10px;
            border-radius: 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            font-size: 0.8rem;
        }

        .overview-title {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #9ca3af;
            margin-bottom: 2px;
        }

        .overview-main {
            font-size: 0.95rem;
            font-weight: 600;
            color: #111827;
        }

        .overview-sub {
            font-size: 0.78rem;
            color: #6b7280;
        }

        .overview-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .overview-refresh-btn {
            border: none;
            background: #eef2ff;
            border-radius: 999px;
            width: 22px;
            height: 22px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0;
            margin-left: 6px;
        }

        .overview-refresh-btn:hover {
            background: #e0e7ff;
        }


        .weekly-strip {
            display: flex;
            flex-wrap: nowrap;
            gap: 6px;
            margin-top: 4px;
            overflow-x: auto;
        }

        .weekly-day {
            min-width: 48px;
            padding: 4px 6px;
            border-radius: 10px;
            background: #eef2ff;
            font-size: 0.74rem;
            text-align: center;
            color: #4338ca;
        }

        .weekly-day.has-classes {
            background: #e0f2fe;
            color: #0369a1;
        }

        .weekly-day.today {
            background: #dcfce7;
            color: #166534;
            font-weight: 600;
        }

        /* NEW: Students tile animation */
        .students-tile {
            position: relative;
        }

        .students-tile::before {
            content: "üë©‚Äçüè´";
            position: absolute;
            right: 10px;
            bottom: 8px;
            font-size: 1.6rem;
            opacity: 0.7;
            animation: gentlyBounce 3.2s ease-in-out infinite;
        }

        @keyframes gentlyBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        /* NEW: Motivation tile */
        .motivation-tile {
            background: radial-gradient(circle at top left, #eef2ff, #e0f2fe 40%, #fce7f3 100%);
            position: relative;
            overflow: hidden;
        }

        .motivation-tile::before {
            content: "‚ú®";
            position: absolute;
            right: 12px;
            bottom: 8px;
            font-size: 1.4rem;
            opacity: 0.5;
            animation: floatSparkle 4s ease-in-out infinite;
        }

        @keyframes floatSparkle {
            0%, 100% { transform: translateY(0); opacity: 0.4; }
            50% { transform: translateY(-4px); opacity: 0.8; }
        }

        /* NEW: Today classes list styles */
        .today-classes-list {
            max-height: 120px;
            overflow-y: auto;
            margin-top: 8px;
        }

        .today-class-item {
            font-size: 0.84rem;
            padding: 4px 0;
            border-bottom: 1px dashed #e5e7eb;
        }

        .today-class-item:last-child {
            border-bottom: none;
        }

        /* NEW: Prevent animation overlap in motivation tile */
        .motivation-tile .overview-main,
        .motivation-tile .overview-sub {
            padding-right: 40px; /* Make space for sparkle animation */
        }

        /* Form */
        .form-group {
            margin-bottom: 10px;
        }

        label {
            display: block;
            font-size: 0.8rem;
            color: #4b5563;
            margin-bottom: 4px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 7px 9px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 0.9rem;
            outline: none;
            background: #f9fafb;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px rgba(79,70,229,0.18);
            background: #ffffff;
        }

        .schedule-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 2px;
        }

        .schedule-hint button {
            border: none;
            background: none;
            padding: 0;
            margin-left: 4px;
            font-size: 0.75rem;
            color: #4f46e5;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            border-radius: 999px;
            border: none;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: #ffffff;
            box-shadow: 0 6px 14px rgba(79,70,229,0.25);
        }

        .btn-primary:hover {
            filter: brightness(1.05);
            transform: translateY(-0.5px);
        }

        .btn-outline {
            background: #ffffff;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }

        .btn-outline:hover {
            background: #f3f4ff;
            border-color: #4f46e5;
            color: #111827;
        }

        .btn-soft {
            background: #eef2ff;
            color: #4338ca;
            border: 1px solid transparent;
        }

        .btn-soft:hover {
            background: #e0e7ff;
        }

        .btn-block {
            width: 100%;
        }

        .inline-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }

        /* Messages */
        .status-block {
            margin-top: 8px;
            font-size: 0.82rem;
        }

        .success, .error, .info, .loading {
            padding: 8px;
            margin-top: 4px;
            border-radius: 6px;
            font-size: 0.82rem;
            border-left-width: 4px;
            border-left-style: solid;
        }

        .success {
            background: #e8f5e9;
            color: #166534;
            border-left-color: #16a34a;
        }

        .error {
            background: #fef2f2;
            color: #b91c1c;
            border-left-color: #ef4444;
        }

        .info {
            background: #eff6ff;
            color: #1d4ed8;
            border-left-color: #3b82f6;
        }

        .loading {
            background: #fef9c3;
            color: #92400e;
            border-left-color: #facc15;
        }

        /* Table */
        .table-wrap {
            margin-top: 8px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.86rem;
        }

        th, td {
            padding: 8px 10px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }

        thead {
            background: #f3f4ff;
        }

        th {
            font-weight: 600;
            color: #374151;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        /* Classes controls & cards */
        .classes-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        .classes-list {
            margin-top: 6px;
        }

        .class-card {
            border-radius: 14px;
            border: 1px solid #e5e7eb;
            padding: 10px 12px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ffffff, #f9fafb);
            box-shadow: 0 4px 12px rgba(15,23,42,0.06);
            position: relative;
            overflow: hidden;
        }

        .class-accent {
            position: absolute;
            inset-inline-start: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }

        .class-card__row {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 6px;
        }

        .class-student {
            font-weight: 600;
            font-size: 0.98rem;
            color: #111827;
        }

        .meta {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .badge {
            padding: 3px 7px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge-green {
            background: #dcfce7;
            color: #166534;
        }

        .expand-block {
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px dashed #e5e7eb;
        }

        .msg-preview {
            padding: 8px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px dashed #d1d5db;
            white-space: pre-wrap;
            font-size: 0.84rem;
        }

        /* Toasts */
        .toast-container {
            position: fixed;
            right: 16px;
            bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 9999;
        }

        .toast {
            min-width: 180px;
            max-width: 260px;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 0.82rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 12px 28px rgba(15,23,42,0.35);
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.22s ease, transform 0.22s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-success {
            background: #16a34a;
            color: #ecfdf3;
        }

        .toast-error {
            background: #b91c1c;
            color: #fee2e2;
        }

        .toast-info {
            background: #2563eb;
            color: #dbeafe;
        }

        .toast-icon {
            font-size: 1rem;
        }

        /* Bulk reminders modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9998;
        }

        .modal-backdrop.show {
            display: flex;
        }

        .modal {
            max-width: 640px;
            width: 100%;
            max-height: 80vh;
            background: #ffffff;
            border-radius: 18px;
            padding: 14px 16px;
            box-shadow: 0 24px 40px rgba(15,23,42,0.35);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .modal-title {
            font-size: 0.98rem;
            font-weight: 600;
        }

        .modal-body {
            overflow-y: auto;
            padding-right: 4px;
        }

        .modal-footer {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            font-size: 0.78rem;
            color: #6b7280;
        }

        .bulk-item {
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 8px;
            margin-bottom: 8px;
            background: #f9fafb;
        }

        .bulk-item-header {
            font-size: 0.86rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .bulk-item-meta {
            font-size: 0.76rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        /* Quick action FAB */
        .fab-container {
            position: fixed;
            right: 16px;
            bottom: 80px;
            z-index: 9997;
        }

        .fab-main {
            width: 44px;
            height: 44px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: #ffffff;
            box-shadow: 0 12px 30px rgba(15,23,42,0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .fab-menu {
            position: absolute;
            bottom: 52px;
            right: 0;
            display: none;
            flex-direction: column;
            gap: 6px;
        }

        .fab-menu.show {
            display: flex;
        }

        .fab-item {
            padding: 6px 10px;
            border-radius: 999px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 8px 18px rgba(15,23,42,0.25);
        }

        /* Footer */
        .footer {
            margin-top: 20px;
            font-size: 0.78rem;
            color: #9ca3af;
            text-align: center;
        }

        .footer span {
            font-weight: 600;
            color: #4f46e5;
        }

        .footer-version {
            margin-top: 2px;
            font-size: 0.74rem;
            color: #9ca3af;
        }

        /* NEW: Fix no classes spacing */
        .today-classes-list:empty {
            display: none;
        }

        @media (max-width: 640px) {
            body {
                padding: 12px;
            }

            .section-card {
                padding: 14px;
            }

            .brand-block, .teacher-block {
                padding: 12px 14px;
            }

            .brand-title {
                font-size: 1.2rem;
            }

            .main-tab-btn {
                font-size: 0.85rem;
                padding: 8px 10px;
            }

            .class-card__row {
                flex-direction: column;
                align-items: flex-start;
            }

            .fab-container {
                bottom: 72px;
            }

            .modal {
                max-width: 95vw;
            }
        }
    </style>
</head>

<body>
<div class="container">

    <header class="top-bar">
        <div class="brand-block">
            <div class="brand-title">
                <span class="icon">üìä</span>
                <span>Advanced Class Manager</span>
            </div>
            <div class="brand-sub">Teacher's Dashboard ‚Äî Powered by LazifAI</div>
            <div class="brand-pill-row">
                <div class="brand-pill" id="clock-sydney">üá¶üá∫ Sydney: --:-- --</div>
                <div class="brand-pill" id="clock-perth">üá¶üá∫ Perth: --:-- --</div>
                <div class="brand-pill" id="clock-london">üá¨üáß London: --:-- --</div>
                <div class="brand-pill" id="clock-uae">üá¶üá™ UAE: --:-- --</div>
                <div class="brand-pill" id="clock-nz">üá≥üáø NZ: --:-- --</div>
            </div>
        </div>
        <div class="teacher-block">
            <div class="teacher-label">WELCOME</div>
            <div class="teacher-name">Senorita Saha</div>
            <div class="teacher-id">Teacher ID: 181577</div>
            <div class="teacher-clock" id="clock-india">üïí India: --:-- --</div>

            <!-- NEW: profile photo -->
            <img
                src="senorita-profile.jpg"
                alt="Senorita Saha"
                class="teacher-avatar" />
        </div>
    </header>

    <div class="global-search-wrap">
        <input
            type="text"
            id="global-search"
            class="global-search-input"
            placeholder="üîé Search students or classes by name, date or time..."
        />
    </div>

    <nav class="main-tabs">
        <button class="main-tab-btn active" data-section="students">
            <span class="tab-icon">üë•</span>
            <span>Manage Students</span>
        </button>
        <button class="main-tab-btn" data-section="classes">
            <span class="tab-icon">üìö</span>
            <span>Manage Classes</span>
        </button>
    </nav>

    <!-- STUDENTS -->
    <section id="section-students" class="section show">
        <div class="section-card">
            <div class="section-header">
                <div>
                    <div class="section-title-row">
                        <span class="section-title-icon">üë•</span>
                        <div class="section-title">Manage Students</div>
                    </div>
                    <div class="section-caption">Add, delete & view all active students linked to your classes.</div>
                </div>
            </div>

            <div class="card-row">
                <div class="card-column">
                    <div class="form-group">
                        <label>Add Student</label>
                        <input id="student-name-input" type="text" placeholder="Enter student name" />
                    </div>
                    <button id="add-student-btn" class="btn btn-primary btn-block">
                        ‚ûï Add Student
                    </button>

                    <div class="form-group" style="margin-top: 16px;">
                        <label>Delete Student</label>
                        <select id="student-delete-select">
                            <option value="">Select student to delete</option>
                        </select>
                    </div>
                    <button id="delete-student-btn" class="btn btn-outline btn-block">
                        üóë Delete Student
                    </button>

                    <div id="manage-students-msg" class="status-block"></div>
                </div>

                <div class="card-column">
                    <label>All Active Students</label>
                    <div class="inline-actions" style="margin-top: 4px;">
                        <button id="refresh-students-btn" class="btn btn-soft">
                            üîÑ Refresh
                        </button>
                    </div>

                    <div id="all-students-content" class="table-wrap"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- CLASSES -->
    <section id="section-classes" class="section">

        <!-- Overview -->
        <div class="section-card">
            <div class="section-header">
                <div>
                    <div class="section-title-row">
                        <span class="section-title-icon">üìà</span>
                        <div class="section-title">Today & Week Overview</div>
                    </div>
                    <div class="section-caption">Quick glance at your students, today‚Äôs workload and this week.</div>
                </div>
            </div>
            <div class="overview-grid">
                <div class="overview-tile students-tile">
                    <div class="overview-title">Students</div>
                    <div class="overview-main" id="stats-total-students">--</div>
                    <div class="overview-sub" id="stats-students-sub">Total active students</div>
                </div>
                <div class="overview-tile">
                    <div class="overview-title">
                    Today at a glance
                    <button type="button" class="overview-refresh-btn" id="refresh-today-btn" title="Refresh today">‚ü≥</button>
                </div>
                    <div class="overview-main" id="stats-today-main">No data</div>
                    <div class="overview-sub" id="stats-today-sub"></div> <!-- no helper text -->
                    <div class="today-classes-list" id="today-classes-list"></div>
                </div>
                <div class="overview-tile">
                    <div class="overview-title">
                    This week
                    <button type="button" class="overview-refresh-btn" id="refresh-week-btn" title="Refresh this week">‚ü≥</button>
                </div>
                    <div class="overview-main" id="stats-week-main">--</div>
                    <div class="overview-sub"></div> <!-- no "(approx)" -->
                    <div class="weekly-strip" id="weekly-strip"></div>
                </div>
                <div class="overview-tile motivation-tile">
                    <div class="overview-title">Motivation</div>
                    <div class="overview-main" id="motivation-main">
                        Today's corrections become tomorrow's clarity.
                    </div>
                    <div class="overview-sub" id="motivation-sub"></div>
                </div>
            </div>
        </div>

        <!-- Schedule -->
        <div class="section-card">
            <div class="section-header">
                <div>
                    <div class="section-title-row">
                        <span class="section-title-icon">üìÖ</span>
                        <div class="section-title">Schedule Class</div>
                    </div>
                    <div class="section-caption">Create a class & Google Calendar event for an existing student.</div>
                </div>
            </div>

            <div class="card-row">
                <div class="card-column">
                    <label>Student</label>
                    <select id="schedule-student-select">
                        <option value="">Select student</option>
                    </select>
                </div>

                <div class="card-column">
                    <label>Class Date</label>
                    <input type="date" id="schedule-date" />
                </div>

                <div class="card-column">
                    <label>Start Time</label>
                    <input type="text" id="schedule-time" placeholder="hh:mm AM/PM" />
                    <!-- suggestion removed -->
    <div id="slot-warning" class="error" style="display:none; margin-top:4px;">‚ö†Ô∏è This time slot is already booked!</div>
                </div>

                <div class="card-column">
                    <label>Repeat (weeks)</label>
                    <select id="schedule-repeat" style="width:100%;padding:7px 9px;border-radius:8px;border:1px solid #d1d5db;background:#f9fafb;">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>
            </div>

            <div class="inline-actions" style="margin-top: 4px;">
                <button id="schedule-class-btn" class="btn btn-primary">
                    ‚úÖ Schedule Class
                </button>
            </div>

            <div id="schedule-msg" class="status-block"></div>
        </div>

        <!-- View Classes -->
        <div class="section-card">
            <div class="section-header">
                <div>
                    <div class="section-title-row">
                        <span class="section-title-icon">üóÇÔ∏è</span>
                        <div class="section-title">View & Manage Classes</div>
                    </div>
                    <div class="section-caption">Filter by date, generate messages, or reschedule classes.</div>
                </div>
                <div class="section-header-right">
                    <button id="send-all-reminders-btn" class="btn btn-soft" style="display:none;">
                        üì§ Send All Reminders
                    </button>
                </div>
            </div>

            <div class="classes-controls">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>Select Date</label>
                    <input type="date" id="view-date" />
                </div>
                <button id="view-classes-btn" class="btn btn-soft">
                    üìÖ Load Classes
                </button>
            </div>

            <div id="view-classes-output" class="classes-list"></div>
        </div>

    </section>

    <footer class="footer">
        <div>Powered by <span>LazifAI</span> ‚Äî Advanced Class Manager.</div>
        <div class="footer-version">üïâÔ∏è‡•ê ‡§®‡§Æ‡§É ‡§∂‡§ø‡§µ‡§æ‡§ØüïâÔ∏è</div>
        <div class="footer-version">Senorita Saha ‚Äî English Language & Public Speaking Educator</div>
    </footer>

    <div id="toast-container" class="toast-container"></div>

    <!-- Bulk reminders modal -->
    <div id="bulk-reminder-backdrop" class="modal-backdrop">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Send All Reminders</div>
                <button id="bulk-reminder-close" class="btn btn-outline" style="padding:4px 8px;font-size:0.78rem;">‚úï</button>
            </div>
            <div class="modal-body" id="bulk-reminder-body"></div>
            <div class="modal-footer">
                <div>Choose template for each student, then copy or open in WhatsApp.</div>
            </div>
        </div>
    </div>

    <!-- Quick action FAB -->
    <div class="fab-container">
        <button class="fab-main" id="fab-main" title="Quick actions">‚ö°</button>
        <div class="fab-menu" id="fab-menu">
            <div class="fab-item" id="fab-add-student">‚ûï Add Student</div>
            <div class="fab-item" id="fab-schedule-class">üìÖ Schedule Class</div>
            <div class="fab-item" id="fab-load-today">üìÜ Load Today</div>
            <div class="fab-item" id="fab-go-classes">üóÇ Classes Tab</div>
        </div>
    </div>
</div>

<script>
    /* Webhooks (unchanged) */
    const WEBHOOKS = {
        ADD: "https://hook.eu2.make.com/hvddse2wcpf6w3m6t2tepmreloar7cjt",
        DELETE: "https://hook.eu2.make.com/79eede2kxvv66jm31atr8jjxmtf5ag9q",
        STUDENTS: "https://hook.eu2.make.com/kemhxja7ouav3ibxeqay4ktpmshw6xsl",
        SCHEDULE: "https://hook.eu2.make.com/m0iyppobmi5ut4bmkkl86rpn6vmjgx1l",
        FETCH_CLASS: "https://hook.eu2.make.com/2y3wy4smt4q9ui0buu15bpm6rbp0eg5p",
        RESCHED: "https://hook.eu2.make.com/qcac281xttvlysap3r9aikrlmm4uja70"
    };

// Get current date in IST timezone (UTC+5:30)
function getCurrentISTDateString() {
    return new Date().toLocaleDateString('en-CA', {
        timeZone: 'Asia/Kolkata',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
}


    /* Global state */
    const APP_STATE = {
        students: [],
        allStudentsClean: [],
        todayDate: null,
        currentClassesDate: null,
        currentClasses: [],
        suggestedTimes: [],
        weeklyCounts: {} // dateStr -> count
    };

    const STUDENT_COLORS = [
        "#6366f1","#ec4899","#10b981","#f97316",
        "#0ea5e9","#a855f7","#f59e0b","#22c55e"
    ];
    const studentColorMap = {};

    /* NEW: Motivation quotes */
    const MOTIVATION_QUOTES = [
        "Small daily efforts create lifetime fluency.",
        "Every corrected sentence builds a more confident speaker.",
        "Consistency beats intensity. One focused class at a time.",
        "Your patience today is your students' confidence tomorrow.",
        "Great communicators are trained, not born."
    ];

    let motivationIndex = -1;

    function showNextMotivation() {
        const main = document.getElementById("motivation-main");
        const sub = document.getElementById("motivation-sub");
        if (!main || !sub || !MOTIVATION_QUOTES.length) return;

        motivationIndex = (motivationIndex + 1) % MOTIVATION_QUOTES.length;
        main.textContent = MOTIVATION_QUOTES[motivationIndex];
        sub.textContent = ""; // Remove "Teacher motivation" text
    }

    function getStudentColor(name) {
        if (!name) return "#4f46e5";
        if (!studentColorMap[name]) {
            const keys = Object.keys(studentColorMap);
            const idx = keys.length % STUDENT_COLORS.length;
            studentColorMap[name] = STUDENT_COLORS[idx];
        }
        return studentColorMap[name];
    }

    function clearAllMessages() {
        const m1 = document.getElementById("manage-students-msg");
        const m2 = document.getElementById("schedule-msg");
        if (m1) m1.innerHTML = "";
        if (m2) m2.innerHTML = "";
    }

    function showMessage(target, html) {
        const el = document.querySelector(target);
        if (el) el.innerHTML = html;
    }

    function showToast(message, type = "success") {
        const container = document.getElementById("toast-container");
        if (!container) return;

        const toast = document.createElement("div");
        toast.className = `toast toast-${type === "error" ? "error" : type === "info" ? "info" : "success"}`;

        const icon = document.createElement("span");
        icon.className = "toast-icon";
        icon.textContent = type === "error" ? "‚ö†Ô∏è" : type === "info" ? "‚ÑπÔ∏è" : "‚úÖ";

        const text = document.createElement("span");
        text.textContent = message;

        toast.appendChild(icon);
        toast.appendChild(text);
        container.appendChild(toast);

        requestAnimationFrame(() => {
            toast.classList.add("show");
        });

        setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => toast.remove(), 200);
        }, 2200);
    }

function hideSlotWarning(){ const w = document.getElementById("slot-warning"); if (w) w.style.display = "none"; }

    async function fetchAPI(url, payload) {
        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload || {})
        });
        const text = await res.text();
        try {
            return JSON.parse(text);
        } catch {
            if (text.trim().toLowerCase() === "accepted") return {};
            throw new Error("Invalid JSON: " + text);
        }
    }

    
    /* ===== Date/time helpers (display) ===== */

    function parseLocalDateFromInput(isoYMD) {
        // isoYMD expected YYYY-MM-DD or DD-MM-YYYY; prefer YYYY-MM-DD here
        if(!isoYMD) return null;
        // accept both formats
        if(isoYMD.indexOf('-')===2) { // DD-MM-YYYY
            const parts = isoYMD.split('-');
            return new Date(parseInt(parts[2],10), parseInt(parts[1],10)-1, parseInt(parts[0],10));
        }
        const parts = isoYMD.split('-');
        return new Date(parseInt(parts[0],10), parseInt(parts[1],10)-1, parseInt(parts[2],10));
    }

    function formatDateToISO(d) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return yyyy + '-' + mm + '-' + dd;
    }

    function addDaysLocal(isoDate, days) {
        const base = parseLocalDateFromInput(isoDate);
        if(!base) return isoDate;
        const d = new Date(base.getTime());
        d.setDate(d.getDate() + days);
        return formatDateToISO(d);
    }

    async function scheduleOccurrences(studentName, dateISO, time24, repeatCount, msgElem) {
        if(!msgElem) msgElem = { innerHTML: function(){} };
        msgElem.innerHTML = '<div class="loading">Scheduling class...</div>';
        try {
            for (let i = 0; i <= repeatCount; i++) {
                const occDate = addDaysLocal(dateISO, i * 7); // compute local date for occurrence
                await fetchAPI(WEBHOOKS.SCHEDULE, {
                    Action: "ScheduleClass",
                    StudentName: studentName,
                    ClassDate: occDate,
                    StartTime: time24,
                    DurationMinutes: 60,
                    RepeatWeeks: false
                });
            }
            msgElem.innerHTML = '<div class="success">‚úÖ Class scheduled.</div>';
            recordUsedTime(time24);
            // refresh lists
            loadStudentsForDropdowns();
            loadAllStudentsTable();
            fetchTodayOverview();
            const viewInput = document.getElementById("view-date");
            if (viewInput && viewInput.value) {
                fetchClassesForDate(viewInput.value);
            }
        } catch (err) {
            console.error(err);
            msgElem.innerHTML = '<div class="error">‚ùå Failed to schedule class.</div>';
        }
    }

    function isoToDisplayDate(isoDate) {
        if (!isoDate) return '';
        let d = new Date(isoDate);
        if (isNaN(d)) {
            const parts = (isoDate||'').split('T')[0].split('-');
            if (parts.length===3) return parts[2].padStart(2,'0') + '-' + parts[1].padStart(2,'0') + '-' + parts[0];
            return isoDate;
        }
        return d.toLocaleDateString('en-GB'); // DD-MM-YYYY
    }

    function time24To12(t24) {
        if (!t24) return '';
        const [hms] = (t24||'').split('.');
        const parts = hms.split(':');
        let hh = parseInt(parts[0]||'0',10);
        const mm = (parts[1]||'00').padStart(2,'0');
        const ampm = hh >= 12 ? 'PM' : 'AM';
        hh = hh % 12;
        if (hh === 0) hh = 12;
        return `${hh}:${mm} ${ampm}`;
    }

    /* removed duplicate addDaysLocal */
    /* ===== AM/PM parser for schedule inputs ===== */
    function parseUserTimeTo24(t) {
        if (!t) return "";
        t = t.trim().toUpperCase();
        const m = t.match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/);
        if (!m) return "";
        let hh = parseInt(m[1], 10);
        const mm = m[2] ? m[2] : "00";
        const ampm = m[3];
        if (ampm === "PM" && hh !== 12) hh += 12;
        if (ampm === "AM" && hh === 12) hh = 0;
        return String(hh).padStart(2, "0") + ":" + mm;
    }
    /* ===== end AM/PM parser ===== */

/* World clocks */
    function initWorldClocks() {
        const ids = {
            india: "Asia/Kolkata",
            sydney: "Australia/Sydney",
            perth: "Australia/Perth",
            london: "Europe/London",
            uae: "Asia/Dubai",
            nz: "Pacific/Auckland"
        };

        function formatTime(tz) {
            const now = new Date();
            return now.toLocaleTimeString("en-GB", {
                timeZone: tz,
                hour: "2-digit",
                minute: "2-digit",
                hour12: true
            });
        }

        
        function updateClocks() {
            // Update clock displays
            const elIndia = document.getElementById("clock-india");
            if (elIndia) elIndia.textContent = "üïí India: " + formatTime(ids.india);

            const s = document.getElementById("clock-sydney");
            if (s) s.textContent = "üá¶üá∫ Sydney: " + formatTime(ids.sydney);

            const p = document.getElementById("clock-perth");
            if (p) p.textContent = "üá¶üá∫ Perth: " + formatTime(ids.perth);

            const l = document.getElementById("clock-london");
            if (l) l.textContent = "üá¨üáß London: " + formatTime(ids.london);

            const u = document.getElementById("clock-uae");
            if (u) u.textContent = "üá¶üá™ UAE: " + formatTime(ids.uae);

            const n = document.getElementById("clock-nz");
            if (n) n.textContent = "üá≥üáø NZ: " + formatTime(ids.nz);

            // NEW: Check for date change
            const currentISTDate = getCurrentISTDateString();
            if (currentISTDate !== APP_STATE.todayDate) {
                console.log("Date changed from", APP_STATE.todayDate, "to", currentISTDate);
                const oldDate = APP_STATE.todayDate;
                APP_STATE.todayDate = currentISTDate;
                
                // Update the view date input only if it was showing the old "today" date
                const viewInput = document.getElementById("view-date");
                if (viewInput && viewInput.value === oldDate) {
                    viewInput.value = currentISTDate;
                }
                
                // Also update schedule date if it was showing the old date
                const schedInput = document.getElementById("schedule-date");
                if (schedInput && schedInput.value === oldDate) {
                    schedInput.value = currentISTDate;
                }
                
                // Reload today's overview data to update overview cards only
                fetchTodayOverview();
            }
        }

        updateClocks();
        setInterval(updateClocks, 1000);
    }

    /* Tabs */
    const mainTabButtons = document.querySelectorAll(".main-tab-btn");
    const sectionStudents = document.getElementById("section-students");
    const sectionClasses = document.getElementById("section-classes");

    function showMainSection(sec) {
        hideSlotWarning();
        clearAllMessages();
        mainTabButtons.forEach(btn =>
            btn.classList.toggle("active", btn.dataset.section === sec)
        );
        sectionStudents.classList.toggle("show", sec === "students");
        sectionClasses.classList.toggle("show", sec === "classes");
    }

    mainTabButtons.forEach(btn =>
        btn.addEventListener("click", () => showMainSection(btn.dataset.section))
    );

    /* Student helpers */
    function updateStudentStats() {
        const total = APP_STATE.allStudentsClean.length;
        const el = document.getElementById("stats-total-students");
        const sub = document.getElementById("stats-students-sub");
        if (el) el.textContent = total || "--";
        if (sub) sub.textContent = total ? "Total active students" : "Add students to get started.";
    }

    function renderStudentTable(filterText = "") {
        const c = document.getElementById("all-students-content");
        if (!c) return;

        const q = (filterText || "").trim().toLowerCase();
        const data = q
            ? APP_STATE.allStudentsClean.filter(n => n.toLowerCase().includes(q))
            : APP_STATE.allStudentsClean.slice();

        if (!data.length) {
            c.innerHTML = '<div class="info">No students found.</div>';
            return;
        }

        let h = '<table><thead><tr><th>#</th><th>Name</th></tr></thead><tbody>';
        data.forEach((n, i) => {
            h += `<tr><td>${i + 1}</td><td>${n}</td></tr>`;
        });
        h += "</tbody></table>";
        c.innerHTML = h;
    }

    async function loadStudentsForDropdowns() {
        try {
            const r = await fetchAPI(WEBHOOKS.STUDENTS, { action: "getAllStudents" });
            const s = r.students || r.data || [];
            APP_STATE.students = s;

            const delSel = document.getElementById("student-delete-select");
            const schSel = document.getElementById("schedule-student-select");

            delSel.innerHTML = '<option value="">Select student to delete</option>';
            schSel.innerHTML = '<option value="">Select student</option>';

            const cleanNames = [];
            s.forEach(x => {
                const n = x.name || x.StudentName || x.student || x;
                if (!n || typeof n !== "string") return;
                cleanNames.push(n);
                delSel.innerHTML += `<option value="${n}">${n}</option>`;
                schSel.innerHTML += `<option value="${n}">${n}</option>`;
            });

            APP_STATE.allStudentsClean = cleanNames;
            updateStudentStats();
            renderStudentTable();
        } catch {
            // silent fail here; table loader has its own error handling
        }
    }

    async function loadAllStudentsTable() {
        const c = document.getElementById("all-students-content");
        c.innerHTML = '<div class="info">Loading students...</div>';
        try {
            const r = await fetchAPI(WEBHOOKS.STUDENTS, { action: "getAllStudents" });
            const s = r.students || r.data || [];
            APP_STATE.students = s;

            const clean = s
                .map(x => x.name || x.StudentName || x.student || x)
                .filter(n => n && typeof n === "string");

            APP_STATE.allStudentsClean = clean;
            updateStudentStats();
            renderStudentTable();
        } catch {
            c.innerHTML = '<div class="error">‚ùå Error loading students.</div>';
        }
    }

    document.getElementById("refresh-students-btn").addEventListener("click", () => {
        loadAllStudentsTable();
        loadStudentsForDropdowns();
    });

    /* Add Student */
    document.getElementById("add-student-btn").addEventListener("click", async () => {
        clearAllMessages();
        const name = document.getElementById("student-name-input").value.trim();
        const msg = document.getElementById("manage-students-msg");

        if (!name) {
            msg.innerHTML = '<div class="error">‚ùå Enter a name.</div>';
            return;
        }

        msg.innerHTML = '<div class="loading">Adding student...</div>';
        try {
            await fetchAPI(WEBHOOKS.ADD, { StudentName: name });
            msg.innerHTML = '<div class="success">‚úÖ Student added.</div>';
            document.getElementById("student-name-input").value = "";
            loadStudentsForDropdowns();
            loadAllStudentsTable();
        } catch {
            msg.innerHTML = '<div class="error">‚ùå Failed to add student.</div>';
        }
    });

    /* Delete Student */
    document.getElementById("delete-student-btn").addEventListener("click", async () => {
        clearAllMessages();
        const sel = document.getElementById("student-delete-select").value;
        const msg = document.getElementById("manage-students-msg");

        if (!sel) {
            msg.innerHTML = '<div class="error">‚ùå Select a student.</div>';
            return;
        }

        msg.innerHTML = '<div class="loading">Deleting student...</div>';
        try {
            await fetchAPI(WEBHOOKS.DELETE, { StudentName: sel });
            msg.innerHTML = '<div class="success">‚úÖ Student deleted.</div>';
            loadStudentsForDropdowns();
            loadAllStudentsTable();
        } catch {
            msg.innerHTML = '<div class="error">‚ùå Failed to delete student.</div>';
        }
    });

    /* Suggested time helpers (localStorage based) */
    function loadSuggestedTimes() {
        try {
            const raw = localStorage.getItem("acm_suggested_times");
            if (!raw) return;
            const arr = JSON.parse(raw);
            if (Array.isArray(arr)) {
                APP_STATE.suggestedTimes = arr;
            }
        } catch {}
    }

    function saveSuggestedTimes() {
        try {
            localStorage.setItem("acm_suggested_times", JSON.stringify(APP_STATE.suggestedTimes || []));
        } catch {}
    }

    function recordUsedTime(timeStr) {
        if (!timeStr) return;
        APP_STATE.suggestedTimes.push(timeStr);
        if (APP_STATE.suggestedTimes.length > 100) {
            APP_STATE.suggestedTimes = APP_STATE.suggestedTimes.slice(-100);
        }
        saveSuggestedTimes();
        updateSuggestedTimeHint();
    }

    
function updateSuggestedTimeHint() {
    const el = document.getElementById("schedule-suggestion");
    if (el) el.innerHTML = "";
}


    /* Schedule Class */
    
document.getElementById("schedule-class-btn").addEventListener("click", async () => {
        clearAllMessages();
        const st = document.getElementById("schedule-student-select").value;
        const dt = document.getElementById("schedule-date").value; // ISO YYYY-MM-DD
        const userTime = document.getElementById("schedule-time").value;
        const tm = parseUserTimeTo24(userTime);
        const repeat = parseInt(document.getElementById("schedule-repeat").value || "0", 10);
        const msg = document.getElementById("schedule-msg");

        if (!st || !dt || !tm) {
            msg.innerHTML = '<div class="error">‚ùå Enter time as hh:mm AM/PM.</div>';
            if (!tm) return;
            msg.innerHTML = '<div class="error">‚ùå Select student, date & time.</div>';
            return;
        }

        // Conflict check: call FETCH_CLASS for that date and compare StartTime
        msg.innerHTML = '<div class="loading">Checking slot availability...</div>';
        try {
            const existing = await fetchAPI(WEBHOOKS.FETCH_CLASS, { selectedDate: dt });
            const classes = existing.classes || [];
            const conflict = classes.some(c => (c.StartTime||c.time||'').trim() === tm.trim());
            if (conflict) {
                const warn = document.getElementById('slot-warning'); if(warn){ warn.style.display='block'; return; }
            }
        } catch (e) {
            console.warn('Slot check failed', e);
        }

        msg.innerHTML = '<div class="loading">Scheduling class...</div>';
        try {
            for (let i = 0; i <= repeat; i++) {
                const occDate = addDaysLocal(dt, i * 7); // compute ISO date for occurrence
                await fetchAPI(WEBHOOKS.SCHEDULE, {
                    Action: "ScheduleClass",
                    StudentName: st,
                    ClassDate: occDate,
                    StartTime: tm,
                    DurationMinutes: 60,
                    RepeatWeeks: false
                });
            }
            msg.innerHTML = '<div class="success">‚úÖ Class scheduled.</div>'; hideSlotWarning();
            recordUsedTime(tm);
            // refresh lists
            loadStudentsForDropdowns();
            loadAllStudentsTable();
            // refresh overview and current view date
            fetchTodayOverview();
            const viewInput = document.getElementById("view-date");
            if (viewInput && viewInput.value) {
                fetchClassesForDate(viewInput.value);
            }
        } catch (err) {
            console.error(err);
            msg.innerHTML = '<div class="error">‚ùå Failed to schedule class.</div>';
        }
    });

    /* Stats for classes */
    function updateClassesStats(dateStr, classes) {
        APP_STATE.currentClassesDate = dateStr;
        APP_STATE.currentClasses = classes || [];

        // basic weekly summary (just counts for loaded date)
        if (dateStr) {
            APP_STATE.weeklyCounts[dateStr] = (classes || []).length;
        }

        const todayMain = document.getElementById("stats-today-main");
        const todaySub = document.getElementById("stats-today-sub");
        const weekMain = document.getElementById("stats-week-main");
        const weeklyStrip = document.getElementById("weekly-strip");
        const todayList = document.getElementById("today-classes-list");

        // today at a glance
        if (dateStr === APP_STATE.todayDate && classes && classes.length) {
            const sorted = [...classes].sort((a, b) => {
                const ta = (a.StartTime || a.time || "00:00");
                const tb = (b.StartTime || b.time || "00:00");
                return ta.localeCompare(tb);
            });
            
            // Update main summary
            if (todayMain) todayMain.textContent = `${classes.length} class${classes.length > 1 ? "es" : ""} today`;
            if (todaySub) todaySub.textContent = "";
            
            // Render list of all classes
            if (todayList) {
                todayList.innerHTML = "";
                sorted.forEach(cls => {
                    const time = cls.StartTime || cls.time || "";
                    const timeDisplay = time24To12(time) || 'Unknown time';
                    const student = cls.StudentName || cls.student || "Unknown student";
                    
                    const item = document.createElement("div");
                    item.className = "today-class-item";
                    item.textContent = `${timeDisplay} - ${student}`;
                    todayList.appendChild(item);
                });
            }
        } else if (dateStr === APP_STATE.todayDate) {
            if (todayMain) todayMain.textContent = "No classes today";
            if (todaySub) todaySub.textContent = "Enjoy your free time.";
            if (todayList) todayList.innerHTML = "";
        } else {
            if (todayList) todayList.innerHTML = "";
        }

        // weekly counts (approx)
        const dates = Object.keys(APP_STATE.weeklyCounts);
        const totalWeek = dates.reduce((sum, d) => sum + (APP_STATE.weeklyCounts[d] || 0), 0);
        if (weekMain) weekMain.textContent = totalWeek ? `${totalWeek} total` : "--";

        if (weeklyStrip) {
            weeklyStrip.innerHTML = "";
            if (!APP_STATE.todayDate) return;
            const base = new Date(APP_STATE.todayDate);
            const baseDay = base.getDay(); // 0 Sun .. 6 Sat
            // show Monday-Sunday of current week
            const start = new Date(base);
            const diffToMonday = (baseDay + 6) % 7;
            start.setDate(base.getDate() - diffToMonday);

            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(start.getDate() + i);
                const iso = d.toISOString().slice(0, 10);
                const count = APP_STATE.weeklyCounts[iso] || 0;
                const div = document.createElement("div");
                div.className = "weekly-day";
                if (count > 0) div.classList.add("has-classes");
                if (iso === APP_STATE.todayDate) div.classList.add("today");
                const label = d.toLocaleDateString("en-GB", { weekday: "short" });
                div.textContent = `${label}\n${count || "-"}`;
                weeklyStrip.appendChild(div);
            }
        }
    }

    /* Message builder shared */
    function buildMessageText(type, student, dateISO, time24) {
        const date = isoToDisplayDate(dateISO);
        const time = time24To12(time24);
        const A =
            `Hi, this is a reminder that ${student} has an English class scheduled on ${date} at ${time}.\n\n` +
            `Please join using your PlanetSpark class link.\n\n` +
            `Regards,\nSenorita Saha\nPowered by LazifAI.`;

        const B =
            `Hi, this is a reminder that ${student} has an English class scheduled on ${date} at ${time}.\n\n` +
            `Meeting Link: ______________________ (paste link here)\n\n` +
            `Regards,\nSenorita Saha\nPowered by LazifAI.`;

        return type === "meet" ? B : A;
    }

    /* renderClassCards ‚Äî with no-classes + empty-object filter + search + accents */
    function renderClassCards(classes, dateStr, searchQuery = "") {
        const container = document.getElementById("view-classes-output");
        const sendAllBtn = document.getElementById("send-all-reminders-btn");

        let valid = (classes || []).filter(c =>
            c && (
                c.StudentName || c.student ||
                c.ClassDate || c.date ||
                c.StartTime || c.time
            )
        );

        APP_STATE.currentClasses = valid;
        APP_STATE.currentClassesDate = dateStr || null;
        // Don't call updateClassesStats here to avoid interfering with overview cards

        if (!valid.length) {
            container.innerHTML = '<div class="info">No classes scheduled for this date.</div>';
            if (sendAllBtn) sendAllBtn.style.display = "none";
            return;
        }

        const q = (searchQuery || "").trim().toLowerCase();
        container.innerHTML = "";
        let renderedCount = 0;

        valid.forEach(c => {
            const student = c.StudentName || c.student || "Unknown student";
            const date = c.ClassDate || c.date || "";
            const dateDisplay = isoToDisplayDate(date) || "Unknown date";
            const time = c.StartTime || c.time || "";
            const timeDisplay = time24To12(time) || "Unknown time";
            const classId = c.ClassID || c.id || "-";
            const calId = c.CalendarEventID || "";

            const searchText = (student + " " + date + " " + time + " " + classId).toLowerCase();
            if (q && !searchText.includes(q)) return;

            const card = document.createElement("div");
            card.className = "class-card";

            const accent = document.createElement("div");
            accent.className = "class-accent";
            accent.style.background = getStudentColor(student);
            card.appendChild(accent);

            card.insertAdjacentHTML("beforeend", `
                <div class="class-card__row">
                    <div>
                        <div class="class-student">üë§ ${student}</div>
                        <div class="meta">üìÖ ${dateDisplay} ‚Ä¢ ‚è∞ ${timeDisplay}</div>
                        <div class="meta">üÜî Class ID: ${classId}</div>
                        ${calId ? `<div class="meta">üìé Event ID: ${calId}</div>` : ""}
                    </div>
                    <div><span class="badge badge-green">Scheduled</span></div>
                </div>

                <div class="inline-actions">
                    <button class="btn btn-soft btn-generate">üí¨ Generate Message</button>
                    <button class="btn btn-outline btn-reschedule">üîÅ Reschedule</button>
                </div>

                <div class="expand-block generate-area" style="display:none;">
                    <label>Message Type</label>
                    <select class="msg-type-select">
                        <option value="ps">PS Class</option>
                        <option value="meet">Google Meet</option>
                    </select>
                    <label style="margin-top:6px;">Message Preview</label>
                    <div class="msg-preview"></div>
                    <div class="inline-actions" style="margin-top:6px;">
                        <button class="btn btn-primary btn-copy">üìã Copy</button>
                        <button class="btn btn-outline btn-wa">üí¨ WhatsApp</button>
                    </div>
                </div>

                <div class="expand-block resched-area" style="display:none;">
                    <div class="form-group">
                        <label>New Date</label>
                        <input type="date" class="res-date" value="${date}">
                    </div>
                    <div class="form-group">
    <label>New Time</label>
    <input type="text" class="res-time" value="${timeDisplay}" placeholder="hh:mm AM/PM">
    <div class="slot-warning-resched error" style="display:none; margin-top:4px;">‚ö†Ô∏è This time slot is already booked!</div>
</div>
                    <button class="btn btn-primary btn-block btn-res-submit">Save Reschedule</button>
                </div>
            `);

            /* Messaging */
            const msgArea = card.querySelector(".generate-area");
            const preview = card.querySelector(".msg-preview");
            const typeSel = card.querySelector(".msg-type-select");

            card.querySelector(".btn-generate").addEventListener("click", () => {
                const show = msgArea.style.display === "none";
                msgArea.style.display = show ? "block" : "none";
                if (show) preview.textContent = buildMessageText(typeSel.value, student, date, time);
            });

            typeSel.addEventListener("change", () => {
                if (msgArea.style.display !== "none") {
                    preview.textContent = buildMessageText(typeSel.value, student, date, time);
                }
            });

            /* Copy (uses toast, does NOT close cards) */
            card.querySelector(".btn-copy").addEventListener("click", () => {
                const text = preview.textContent || "";
                navigator.clipboard.writeText(text);
                showToast("Message copied to clipboard", "success");
            });

            /* WhatsApp */
            card.querySelector(".btn-wa").addEventListener("click", () => {
                const url = "https://wa.me/?text=" + encodeURIComponent(preview.textContent || "");
                window.open(url, "_blank");
            });

            /* Reschedule */
            const resArea = card.querySelector(".resched-area");
            card.querySelector(".btn-reschedule").addEventListener("click", () => {
                const show = resArea.style.display === "none";
                resArea.style.display = show ? "block" : "none";
            });

            card.querySelector(".btn-res-submit").addEventListener("click", async () => {
                const nd = card.querySelector(".res-date").value;
                const userNewTime = card.querySelector(".res-time").value;
                const nt = parseUserTimeTo24(userNewTime);

                if (!nd || !nt) {
                    showMessage("#view-classes-output", '<div class="error">‚ùå Enter time as hh:mm AM/PM.</div>');
                    showMessage("#view-classes-output", '<div class="error">‚ùå Select date & time.</div>');
                    return;
                }

                // Check for slot conflict (excluding current class)
    
    try {
        const existing = await fetchAPI(WEBHOOKS.FETCH_CLASS, { selectedDate: nd });
        const classes = existing.classes || [];
        const conflict = classes.some(c => (c.StartTime||c.time||'').trim() === nt.trim() && (c.ClassID || c.id) !== classId);
        if (conflict) {
            const warn = card.querySelector('.slot-warning-resched');
            if(warn) { warn.style.display='block'; return; }
        }
    } catch(e){ console.warn('Slot check failed', e);} 

    showMessage("#view-classes-output", '<div class="loading">Rescheduling...</div>');

                try {
                    await fetchAPI(WEBHOOKS.RESCHED, {
                        StudentName: student,
                        OldDate: date,
                        NewDate: nd,
                        NewTime: nt,
                        CalendarEventID: calId,
                        ClassID: classId
                    });
                    showMessage("#view-classes-output", '<div class="success">‚úÖ Rescheduled.</div>');
                    showToast("Class rescheduled", "success");
                    recordUsedTime(nt);
                } catch {
                    showMessage("#view-classes-output", '<div class="error">‚ùå Failed.</div>');
                    showToast("Reschedule failed", "error");
                }
            });

            container.appendChild(card);

// Auto-hide warning
const resDateInput = card.querySelector(".res-date");
const resTimeInput = card.querySelector(".res-time");
const slotWarning = card.querySelector(".slot-warning-resched");
if(resDateInput && resTimeInput && slotWarning){
 const hideWarning=()=>slotWarning.style.display="none";
 resDateInput.addEventListener("change", hideWarning);
 resTimeInput.addEventListener("input", hideWarning);
}

// time auto detection
if(resTimeInput){
 const existingError=resTimeInput.parentNode.querySelector(".small");
 if(existingError) existingError.remove();
 const errDiv=document.createElement("div");
 errDiv.className="small";errDiv.style.color="red";errDiv.style.marginTop="4px";errDiv.style.display="none";errDiv.innerText="Invalid time format";
 resTimeInput.parentNode.appendChild(errDiv);
 resTimeInput.addEventListener("blur",()=>{
   const normalized=normalizeUserTime(resTimeInput.value);
   if(normalized===null){errDiv.style.display="block";} else {errDiv.style.display="none";resTimeInput.value=normalized;}
 });
}
            renderedCount++;
        });

        if (!renderedCount) {
            container.innerHTML = '<div class="info">No classes match your search for this date.</div>';
            if (sendAllBtn) sendAllBtn.style.display = "none";
        } else if (sendAllBtn) {
            sendAllBtn.style.display = "inline-flex";
            sendAllBtn.textContent = `üì§ Send All Reminders (${renderedCount})`;
        }
    }

    /* Load classes */
    async function fetchClassesForDate(date) {
        const out = document.getElementById("view-classes-output");
        if (!date) {
            out.innerHTML = '<div class="error">‚ùå Select a date.</div>';
            return;
        }
        out.innerHTML = '<div class="loading">Loading classes...</div>';
        try {
            const d = await fetchAPI(WEBHOOKS.FETCH_CLASS, { selectedDate: date });
            renderClassCards(d.classes || [], date);
        } catch {
            out.innerHTML = '<div class="error">‚ùå Error loading classes.</div>';
        }
    }

    /* NEW: Separate function to update overview cards only */
    async function fetchTodayOverview() {
        if (!APP_STATE.todayDate) return;
        
        try {
            const d = await fetchAPI(WEBHOOKS.FETCH_CLASS, { selectedDate: APP_STATE.todayDate });
            updateClassesStats(APP_STATE.todayDate, d.classes || []);
        } catch (e) {
            console.error("Failed to load today overview:", e);
            updateClassesStats(APP_STATE.todayDate, []);
        }
    }

    // Manual refresh buttons for Today at a glance and This week
    const refreshTodayBtn = document.getElementById("refresh-today-btn");
    if (refreshTodayBtn) {
        refreshTodayBtn.addEventListener("click", () => {
            fetchTodayOverview();
        });
    }
    const refreshWeekBtn = document.getElementById("refresh-week-btn");
    if (refreshWeekBtn) {
        refreshWeekBtn.addEventListener("click", () => {
            fetchTodayOverview();
        });
    }


    document.getElementById("view-classes-btn").addEventListener("click", async () => {
        clearAllMessages();
        const date = document.getElementById("view-date").value;
        fetchClassesForDate(date);
    });

    /* Bulk reminders modal */
    const bulkBackdrop = document.getElementById("bulk-reminder-backdrop");
    const bulkBody = document.getElementById("bulk-reminder-body");
    const bulkClose = document.getElementById("bulk-reminder-close");
    const sendAllBtn = document.getElementById("send-all-reminders-btn");

    function openBulkReminderModal() {
        if (!APP_STATE.currentClasses || !APP_STATE.currentClasses.length) return;
        bulkBody.innerHTML = "";

        APP_STATE.currentClasses.forEach((c, index) => {
            const student = c.StudentName || c.student || "Unknown student";
            const date = c.ClassDate || c.date || "";
            const dateDisplay = isoToDisplayDate(date) || "Unknown date";
            const time = c.StartTime || c.time || "";
            const timeDisplay = time24To12(time) || "Unknown time";

            const item = document.createElement("div");
            item.className = "bulk-item";

            item.innerHTML = `
                <div class="bulk-item-header">üßë ${student}</div>
                <div class="bulk-item-meta">üìÖ ${dateDisplay} ‚Ä¢ ‚è∞ ${timeDisplay}</div>
                <div class="form-group">
                    <label>Message Type for this student</label>
                    <select class="bulk-type">
                        <option value="ps">PS Class</option>
                        <option value="meet">Google Meet</option>
                    </select>
                </div>
                <div class="msg-preview bulk-preview"></div>
                <div class="inline-actions" style="margin-top:6px;">
                    <button class="btn btn-primary bulk-copy">üìã Copy</button>
                    <button class="btn btn-outline bulk-wa">üí¨ WhatsApp</button>
                </div>
            `;

            const typeSel = item.querySelector(".bulk-type");
            const preview = item.querySelector(".bulk-preview");
            const copyBtn = item.querySelector(".bulk-copy");
            const waBtn = item.querySelector(".bulk-wa");

            function updatePreview() {
                preview.textContent = buildMessageText(typeSel.value, student, date, time);
            }

            typeSel.addEventListener("change", updatePreview);
            updatePreview();

            copyBtn.addEventListener("click", () => {
                navigator.clipboard.writeText(preview.textContent || "");
                showToast(`Copied message for ${student}`, "success");
            });

            waBtn.addEventListener("click", () => {
                const url = "https://wa.me/?text=" + encodeURIComponent(preview.textContent || "");
                window.open(url, "_blank");
            });

            bulkBody.appendChild(item);
        });

        bulkBackdrop.classList.add("show");
    }

    if (sendAllBtn) {
        sendAllBtn.addEventListener("click", () => {
            if (!APP_STATE.currentClasses || !APP_STATE.currentClasses.length) return;
            openBulkReminderModal();
        });
    }

    if (bulkClose) {
        bulkClose.addEventListener("click", () => bulkBackdrop.classList.remove("show"));
    }

    bulkBackdrop.addEventListener("click", (e) => {
        if (e.target === bulkBackdrop) {
            bulkBackdrop.classList.remove("show");
        }
    });

    /* Global search */
    document.getElementById("global-search").addEventListener("input", (e) => {
        const q = e.target.value || "";
        // students
        renderStudentTable(q);
        // classes
        if (APP_STATE.currentClasses && APP_STATE.currentClasses.length && APP_STATE.currentClassesDate) {
            renderClassCards(APP_STATE.currentClasses, APP_STATE.currentClassesDate, q);
        }
    });

    /* Quick action FAB */
    const fabMain = document.getElementById("fab-main");
    const fabMenu = document.getElementById("fab-menu");
    const fabAddStudent = document.getElementById("fab-add-student");
    const fabSchedule = document.getElementById("fab-schedule-class");
    const fabLoadToday = document.getElementById("fab-load-today");
    const fabGoClasses = document.getElementById("fab-go-classes");

    fabMain.addEventListener("click", () => {
        fabMenu.classList.toggle("show");
    });

    fabAddStudent.addEventListener("click", () => {
        showMainSection("students");
        fabMenu.classList.remove("show");
        document.getElementById("student-name-input")?.focus();
    });

    fabSchedule.addEventListener("click", () => {
        showMainSection("classes");
        fabMenu.classList.remove("show");
        document.getElementById("schedule-date")?.focus();
    });

    fabGoClasses.addEventListener("click", () => {
        showMainSection("classes");
        fabMenu.classList.remove("show");
    });

    fabLoadToday.addEventListener("click", () => {
        showMainSection("classes");
        fabMenu.classList.remove("show");
        if (APP_STATE.todayDate) {
            const viewInput = document.getElementById("view-date");
            if (viewInput) viewInput.value = APP_STATE.todayDate;
            fetchClassesForDate(APP_STATE.todayDate);
        }
    });

    /* init */
    window.addEventListener("load", () => {
    document.getElementById("schedule-time")?.addEventListener("input", hideSlotWarning);
    document.getElementById("schedule-date")?.addEventListener("change", hideSlotWarning);
        // set today date
        APP_STATE.todayDate = getCurrentISTDateString();
        const viewInput = document.getElementById("view-date");
        const schedDate = document.getElementById("schedule-date");
        if (viewInput) viewInput.value = APP_STATE.todayDate;
        if (schedDate) schedDate.value = APP_STATE.todayDate;

        showMainSection("students");
        initWorldClocks();
        loadStudentsForDropdowns();
        loadAllStudentsTable();
        loadSuggestedTimes();
        updateSuggestedTimeHint();

        // NEW: Load today's overview data only (not the full view classes list)
        fetchTodayOverview();

        // NEW: Auto-refresh overview every 10 minutes
        setInterval(fetchTodayOverview, 10 * 60 * 1000);

        // NEW: motivation quotes rotation
        showNextMotivation();
        setInterval(showNextMotivation, 30000); // change quote every 30s
    });

// === Time Normalizer with Error Indicator ===
function normalizeUserTime(t) {
    if (!t) return "";
    t = t.trim().toUpperCase();
    t = t.replace(/\s+/g,"");

    // Match 24h: "16:00"
    let m24 = t.match(/^(\d{1,2}):(\d{2})$/);
    if (m24){
        let hh=parseInt(m24[1],10), mm=m24[2];
        if(hh>23||mm>59) return null;
        let ap = hh>=12?"PM":"AM";
        hh = (hh%12)||12;
        return hh + ":" + mm + " " + ap;
    }

    // Match hAM, hPM, h:mmAM, h:mmPM
    let m12 = t.match(/^(\d{1,2})(?::(\d{2}))?(AM|PM)$/);
    if (m12){
        let hh=parseInt(m12[1],10), mm=m12[2]?m12[2]:"00";
        if(hh<1||hh>12||mm>59) return null;
        return hh + ":" + mm + " " + m12[3];
    }

    return null;
}

function attachNormalizer(selector){
    document.querySelectorAll(selector).forEach(field=>{
        let err = document.createElement("div");
        err.className="small";
        err.style.color="red";
        err.style.marginTop="4px";
        err.style.display="none";
        err.innerText="Invalid time format";
        field.insertAdjacentElement("afterend", err);

        field.addEventListener("blur", ()=>{
            const fixed = normalizeUserTime(field.value);
            if(fixed===null){
                err.style.display="block";
            } else {
                err.style.display="none";
                field.value = fixed;
            }
        });
    });
}

document.addEventListener("DOMContentLoaded", ()=>{
    attachNormalizer("#schedule-time");
    attachNormalizer(".res-time");
});

</script>
</body>
</html>
